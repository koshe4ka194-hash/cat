function generateCode() {
    const targets = document.getElementById('t_links').value.split(',').map(s => s.trim()).filter(s => s.length > 5);
    const decoys = document.getElementById('d_links').value.split(',').map(s => s.trim()).filter(s => s.length > 5);
    const time = document.getElementById('t_time').value;
    const color = document.getElementById('t_color').value;
    const winMsg = document.getElementById('t_win').value;

    const targetsJSON = JSON.stringify(targets);
    const decoysJSON = JSON.stringify(decoys);

    const code = `<div id="NEURO_WRAPPER" style="width:100%; height:500px; position:relative; background:#ffffff; overflow:hidden; border:2px solid #eee; user-select:none;">
<style>
  #stage { position:absolute; width:100%; height:100%; top:0; left:0; }
  .item { 
    position:absolute; width:100%; height:100%; 
    background-size:contain; background-repeat:no-repeat; background-position:center; 
    cursor:pointer; transition: all 0.2s ease;
    mix-blend-mode: multiply;
    z-index: 1;
  }
  /* Класс для выделения */
  .marked-target { 
    mix-blend-mode: normal !important;
    filter: drop-shadow(0 0 5px ${color}) drop-shadow(0 0 15px ${color}) !important;
    z-index: 100 !important;
    transform: scale(1.05) !important;
  }
  #timer_gui { position:absolute; top:0; left:0; height:8px; background:${color}; width:100%; z-index:200; transition: width 1s linear; }
  .win-layer { 
    position:absolute; top:0; left:0; width:100%; height:100%; 
    background:rgba(255,255,255,0.95); display:none; flex-direction:column; 
    align-items:center; justify-content:center; text-align:center; z-index:1000; font-family:sans-serif;
  }
</style>

<div id="timer_gui"></div>
<div id="stage"></div>
<div id="win_scr" class="win-layer">
  <h2 style="color:#333; margin-bottom:20px; padding:0 10px;">${winMsg}</h2>
  <button onclick="location.reload()" style="padding:12px 24px; background:${color}; color:#fff; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">ИГРАТЬ СНОВА</button>
</div>

<script>
(function(){
  const ts = ${targetsJSON}, ds = ${decoysJSON}, gTime = ${time};
  const stage = document.getElementById('stage'), line = document.getElementById('timer_gui');
  let found = 0, timeLeft = gTime;

  let items = [...ts.map(u=>({u, t:true})), ...ds.map(u=>({u, t:false}))].sort(()=>Math.random()-0.5);

  items.forEach(item => {
    const el = document.createElement('div');
    el.className = 'item';
    el.style.backgroundImage = "url('" + item.u + "')";
    
    // Нейро-разброс
    const r = Math.random()*60-30;
    const tx = Math.random()*60-30;
    const ty = Math.random()*60-30;
    el.style.transform = "translate("+tx+"px,"+ty+"px) rotate("+r+"deg) scale(0.85)";
    
    el.onclick = function(e) {
      e.stopPropagation();
      if(item.t && !this.classList.contains('marked-target')) {
        this.classList.add('marked-target');
        found++;
        if(found === ts.length) { 
          clearInterval(it); 
          setTimeout(()=> { document.getElementById('win_scr').style.display='flex'; }, 600); 
        }
      } else if(!item.t) {
        // Эффект промаха
        this.style.transform += " shake 0.2s"; 
        this.style.opacity = "0.4";
        setTimeout(()=> { this.style.opacity = "1"; }, 400);
      }
    };
    stage.appendChild(el);
  });

  const it = setInterval(()=>{
    timeLeft--;
    line.style.width = (timeLeft/gTime*100) + "%";
    if(timeLeft <= 0) { 
       clearInterval(it); 
       alert("Время вышло!"); 
       location.reload(); 
    }
  }, 1000);
})();
<\/script>
</div>`;

    document.getElementById('final-code').value = code;
    document.getElementById('output-area').style.display = 'block';
}
